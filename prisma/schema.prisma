generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String           @id @default(uuid())
  email                    String           @unique
  password                 String?
  firstName                String
  lastName                 String
  provider                 UserProvider     @default(LOCAL)
  providerId               String?
  isVerified               Boolean          @default(false)
  isSuspended              Boolean          @default(false)
  verificationToken        String?
  resetPasswordToken       String?
  resetPasswordExpires     DateTime?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  verificationTokenExpires DateTime?
  analysisResults          AnalysisResult[]
  jobs                     JobDescription[]
  resumes                  Resume[]
  feedbacks                Feedback[]

  @@index([email])
  @@index([createdAt])
}

model Resume {
  id            String           @id @default(uuid())
  userId        String
  fileName      String
  fileUrl       String
  fileKey       String
  fileSize      Int
  mimeType      String
  extractedText String?
  version       Int              @default(1)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  analyses      AnalysisResult[]
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model JobDescription {
  id          String           @id @default(uuid())
  userId      String
  title       String
  company     String
  description String
  location    String?
  salary      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  analyses    AnalysisResult[]
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model AnalysisResult {
  id              String          @id @default(uuid())
  userId          String
  resumeId        String
  jobId           String?
  matchScore      Float?
  matchedSkills   String[]        @default([])
  missingSkills   String[]        @default([])
  experienceMatch String?
  recommendations String?
  summary         String?
  createdAt       DateTime        @default(now())
  error           String?
  gaps            Json?
  qualityScores   Json?
  status          AnalysisStatus  @default(PROCESSING)
  suggestions     Json?
  updatedAt       DateTime        @default(now())
  job             JobDescription? @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume          Resume          @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resumeId])
  @@index([jobId])
  @@index([status])
  @@index([createdAt])
}

enum UserProvider {
  LOCAL
  GOOGLE
  GITHUB
}

enum AnalysisStatus {
  PROCESSING
  COMPLETED
  FAILED
}

model Feedback {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int
  category  String
  comment   String         @db.Text
  status    FeedbackStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  ADDRESSED
}

// Admin models
model Admin {
  id           String     @id @default(uuid())
  email        String     @unique
  password     String
  firstName    String
  lastName     String
  role         AdminRole  @default(ADMIN)
  isActive     Boolean    @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  auditLogs    AuditLog[]

  @@index([email])
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

model AuditLog {
  id          String   @id @default(uuid())
  adminId     String?
  admin       Admin?   @relation(fields: [adminId], references: [id], onDelete: SetNull)
  action      String
  targetType  String
  targetId    String?
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([adminId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
}
